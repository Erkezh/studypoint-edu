name: Deploy Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  issues: write

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  frontend-build-check:
    name: Frontend Build Check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.12.0"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        env:
          VITE_API_URL: ""
        run: npm run build-only

  deploy:
    name: Deploy To Server
    runs-on: ubuntu-latest
    needs: frontend-build-check
    timeout-minutes: 30
    steps:
      - name: Validate deploy secrets
        env:
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
          DEPLOY_SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
          DEPLOY_SSH_PASSWORD: ${{ secrets.DEPLOY_SSH_PASSWORD }}
          DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
        run: |
          set -euo pipefail

          [ -n "$DEPLOY_SSH_HOST" ] || { echo "::error::DEPLOY_SSH_HOST is empty"; exit 1; }
          [ -n "$DEPLOY_SSH_USER" ] || { echo "::error::DEPLOY_SSH_USER is empty"; exit 1; }
          if [ -z "$DEPLOY_SSH_PRIVATE_KEY" ] && [ -z "$DEPLOY_SSH_PASSWORD" ]; then
            echo "::error::Set DEPLOY_SSH_PRIVATE_KEY or DEPLOY_SSH_PASSWORD"
            exit 1
          fi
          if [ -n "$DEPLOY_SSH_PASSWORD" ]; then
            echo "::notice::Using password authentication for SSH deploy."
          else
            echo "::notice::Using private key authentication for SSH deploy."
          fi

          if [ -n "$DEPLOY_SSH_PORT" ] && ! [[ "$DEPLOY_SSH_PORT" =~ ^[0-9]+$ ]]; then
            echo "::error::DEPLOY_SSH_PORT must be numeric. Current value: '$DEPLOY_SSH_PORT'"
            exit 1
          fi

      - name: Require Nur1sat approval for non-owner deploys
        if: github.actor != 'Nur1sat'
        timeout-minutes: 1440
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.token }}
          approvers: Nur1sat
          minimum-approvals: 1
          issue-title: "Approve production deploy: ${{ github.sha }}"
          issue-body: |
            Deployment requested by @${{ github.actor }}.
            Branch: `${{ github.ref_name }}`
            Commit: `${{ github.sha }}`
            Reply with `approve` to continue or `deny` to stop.
          exclude-workflow-initiator-as-approver: true

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.0
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_DOMAIN: ${{ secrets.DEPLOY_DOMAIN }}
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          port: ${{ secrets.DEPLOY_SSH_PORT != '' && secrets.DEPLOY_SSH_PORT || '22' }}
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_PASSWORD == '' && secrets.DEPLOY_SSH_PRIVATE_KEY || '' }}
          password: ${{ secrets.DEPLOY_SSH_PASSWORD != '' && secrets.DEPLOY_SSH_PASSWORD || '' }}
          debug: true
          command_timeout: 60m
          envs: DEPLOY_PATH,DEPLOY_DOMAIN
          script: |
            set -Eeuo pipefail

            REPO_DIR="${DEPLOY_PATH:-}"
            DOMAIN="${DEPLOY_DOMAIN:-}"

            if [ -z "$REPO_DIR" ]; then
              for candidate in "/opt/studypoint-edu" "/studypoint-edu/studypoint-edu" "$HOME/studypoint-edu"; do
                if [ -d "$candidate/.git" ]; then
                  REPO_DIR="$candidate"
                  break
                fi
              done
            fi

            if [ -z "$REPO_DIR" ] || [ ! -d "$REPO_DIR/.git" ]; then
              echo "Repository not found. Set DEPLOY_PATH secret."
              echo "Checked: /opt/studypoint-edu, /studypoint-edu/studypoint-edu, $HOME/studypoint-edu"
              exit 1
            fi

            echo "Using repository path: $REPO_DIR"

            USE_SUDO=0
            if sudo -n true >/dev/null 2>&1; then
              USE_SUDO=1
              echo "Using passwordless sudo for privileged commands."
            else
              echo "Passwordless sudo is not available. Trying deployment without sudo."
            fi

            run_privileged() {
              if [ "$USE_SUDO" -eq 1 ]; then
                sudo -n "$@"
              else
                "$@"
              fi
            }

            if ! run_privileged docker compose version >/dev/null 2>&1; then
              echo "Cannot run 'docker compose' as current user."
              echo "Fix one of these:"
              echo "1) Add passwordless sudo for docker/systemctl"
              echo "2) Add deploy user to docker group and relogin"
              exit 1
            fi

            cd "$REPO_DIR"
            git fetch origin main --prune
            git checkout main
            git pull --ff-only origin main

            cd "$REPO_DIR/backend"
            run_privileged docker compose up -d --build
            run_privileged docker compose run --rm api python -m alembic upgrade head

            cd "$REPO_DIR"
            npm ci
            cat > "$REPO_DIR/.env" <<'ENV'
            VITE_API_URL=
            ENV
            npm run build-only

            if [ "$USE_SUDO" -eq 1 ] && sudo -n systemctl list-unit-files | grep -q '^studypoint-frontend.service'; then
              sudo -n systemctl restart studypoint-frontend
            elif [ "$USE_SUDO" -eq 0 ] && systemctl list-unit-files 2>/dev/null | grep -q '^studypoint-frontend.service'; then
              echo "studypoint-frontend.service exists but no sudo. Skipping service restart."
            else
              pkill -f "vite preview -- --host 0.0.0.0 --port 5174" || true
              nohup npm run preview -- --host 0.0.0.0 --port 5174 --strictPort >/tmp/studypoint-frontend.log 2>&1 &
            fi

            if [ "$USE_SUDO" -eq 1 ] && sudo -n systemctl list-unit-files | grep -q '^studypoint-backend.service'; then
              sudo -n systemctl restart studypoint-backend
            elif [ "$USE_SUDO" -eq 0 ] && systemctl list-unit-files 2>/dev/null | grep -q '^studypoint-backend.service'; then
              echo "studypoint-backend.service exists but no sudo. Skipping service restart."
            fi

            curl -fsS http://127.0.0.1:8001/docs >/dev/null
            curl -fsSI http://127.0.0.1:5174/ >/dev/null

            if [ -n "$DOMAIN" ]; then
              curl -fsSI "https://${DOMAIN}/" >/dev/null
            fi

            echo "Deployment finished successfully."
