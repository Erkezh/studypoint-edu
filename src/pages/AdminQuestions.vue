<template>
  <div class="min-h-screen bg-gray-50">
    <Header />
    <main class="container mx-auto px-4 py-8 max-w-5xl">
      <div class="mb-6">
        <h1 class="text-3xl font-bold mb-2">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—Ç—ñ —Ç–∞–ø—Å—ã—Ä–º–∞ “õ–æ—Å—É</h1>
        <p class="text-gray-600">–ú“±–Ω–¥–∞ —Å—ñ–∑ –¥–∞–π—ã–Ω –∫–æ–¥—Ç—ã –∫—ñ—Ä—ñ—Å—Ç—ñ—Ä–µ –∞–ª–∞—Å—ã–∑</p>
      </div>

      <div v-if="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        {{ error }}
      </div>

      <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
      <div class="bg-blue-50 border-l-4 border-blue-400 p-6 mb-6 rounded">
        <h2 class="text-xl font-semibold text-blue-800 mb-3">üìã –ù“±—Å“õ–∞—É–ª—ã“õ</h2>
        <div class="space-y-3 text-gray-700">
          <div class="bg-white p-4 rounded border border-blue-200">
            <p class="font-semibold text-blue-900 mb-2">‚úÖ –û“£–∞–π 3 “õ–∞–¥–∞–º:</p>
            <ol class="list-decimal list-inside space-y-1 ml-2">
              <li><strong>"–ö–æ–¥—Ç—ã –∫—ñ—Ä—ñ—Å—Ç—ñ—Ä—É"</strong> –±”©–ª—ñ–º—ñ–Ω–µ –¥–∞–π—ã–Ω React –∫–æ–¥—Ç—ã —Ç–æ–ª—ã“ì—ã–º–µ–Ω –∫”©—à—ñ—Ä—ñ–ø “õ–æ–π—ã“£—ã–∑</li>
              <li><strong>"–°–∞“õ—Ç–∞—É"</strong> –±–∞—Ç—ã—Ä–º–∞—Å—ã–Ω –±–∞—Å—ã“£—ã–∑</li>
              <li>–ì–æ—Ç–æ–≤–æ! –¢–µ—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤–∏—Ç—Å—è —É —É—á–µ–Ω–∏–∫–æ–≤</li>
            </ol>
          </div>
          <div class="bg-green-50 p-3 rounded border border-green-200">
            <p class="text-sm text-green-800">
              <strong>üí° –í–∞–∂–Ω–æ:</strong> –í–∞–º –Ω–µ –Ω—É–∂–Ω–æ –Ω–∏—á–µ–≥–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å! –ü—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ - –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ —Å–∏—Å—Ç–µ–º–∞ —Å–¥–µ–ª–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
            </p>
            <ul class="text-sm text-green-700 mt-2 space-y-1 list-disc list-inside ml-2">
              <li>–¢–µ—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤–∏—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ</li>
              <li>–í–æ–ø—Ä–æ—Å—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
              <li>–û—Ç–≤–µ—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
              <li>–í—Å—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑ –∫–æ–¥–∞</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold mb-6">–ñ–∞“£–∞ —Ç–∞–ø—Å—ã—Ä–º–∞ “õ–æ—Å—É</h2>
        
        <form @submit.prevent="handleSubmit" class="space-y-6">
          <!-- –ù–∞–≤—ã–∫ ID –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∫—Ä—ã—Ç - —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ -->
          <!-- –ê–¥–º–∏–Ω—É –Ω–µ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å –æ–± —ç—Ç–æ–º -->

          <!-- –°“±—Ä–∞“õ –º”ô—Ç—ñ–Ω—ñ (—Å–∫—Ä—ã—Ç–æ, –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) -->
          <div v-if="showAdvanced" class="border-t pt-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              –°“±—Ä–∞“õ –º”ô—Ç—ñ–Ω—ñ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
            </label>
            <input
              v-model="formData.prompt"
              type="text"
              class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
              placeholder="–ê–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ –∫–æ–¥—Ç–∞–Ω –∞–Ω—ã“õ—Ç–∞–ª–∞–¥—ã"
            />
            <p class="text-xs text-gray-500 mt-1">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∏–∑ –∫–æ–¥–∞</p>
          </div>

          <!-- –ö–æ–¥—Ç—ã –∫—ñ—Ä—ñ—Å—Ç—ñ—Ä—É -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              –ö–æ–¥—Ç—ã –∫—ñ—Ä—ñ—Å—Ç—ñ—Ä—É <span class="text-red-500">*</span>
            </label>
            <div class="bg-green-50 border-2 border-green-300 rounded-lg p-4 mb-2">
              <p class="text-sm text-green-800 font-medium mb-2">‚úÖ –û“£–∞–π:</p>
              <p class="text-sm text-green-700">
                –î–∞–π—ã–Ω React –∫–æ–¥—Ç—ã —Ç–æ–ª—ã“ì—ã–º–µ–Ω –∫”©—à—ñ—Ä—ñ–ø, —Ç”©–º–µ–Ω–¥–µ–≥—ñ ”©—Ä—ñ—Å–∫–µ “õ–æ–π—ã“£—ã–∑. 
                –ë–∞—Ä–ª—ã“õ “õ–∞–∂–µ—Ç—Ç—ñ –∞“õ–ø–∞—Ä–∞—Ç –∞–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ –∞–Ω—ã“õ—Ç–∞–ª–∞–¥—ã!
              </p>
            </div>
            <textarea
              v-model="formData.component_code"
              @input="autoFillFromCode"
              required
              rows="25"
              class="w-full p-4 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none font-mono text-xs"
              placeholder="–ú“±–Ω–¥–∞ React –∫–æ–¥—Ç—ã –∫—ñ—Ä—ñ—Å—Ç—ñ—Ä—ñ“£—ñ–∑... (–ë–∞—Ä–ª—ã“õ “õ–∞–∂–µ—Ç—Ç—ñ –∞“õ–ø–∞—Ä–∞—Ç –∞–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ –∞–Ω—ã“õ—Ç–∞–ª–∞–¥—ã)"
            ></textarea>
            <div v-if="autoFilled" class="mt-2 p-2 bg-blue-50 border border-blue-200 rounded text-xs text-blue-700">
              ‚úÖ –ê–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ —Ç–æ–ª—Ç—ã—Ä—ã–ª–¥—ã: {{ autoFilledFields.join(', ') }}
            </div>
            <p class="text-xs text-gray-500 mt-1">
              üí° –ö–µ“£–µ—Å: –ë“Ø–∫—ñ–ª –∫–æ–¥—Ç—ã (import-—Ç–∞–Ω –±–∞—Å—Ç–∞–ø export default-“õ–∞ –¥–µ–π—ñ–Ω) –∫”©—à—ñ—Ä—ñ–ø “õ–æ–π—ã“£—ã–∑
            </p>
          </div>

          <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Å–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
          <div v-if="showAdvanced" class="border-t pt-4 space-y-4">
            <h3 class="text-lg font-semibold text-gray-800">–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            
            <!-- –ù–∞–≤—ã–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - –∞–¥–º–∏–Ω—É –Ω–µ –Ω—É–∂–Ω–æ –æ–± —ç—Ç–æ–º –∑–Ω–∞—Ç—å -->
            <!-- skill_id –≤—Å–µ–≥–¥–∞ 0, —Å–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–π –Ω–∞–≤—ã–∫ -->
            
            <!-- –î“±—Ä—ã—Å –∂–∞—É–∞–ø -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                –î“±—Ä—ã—Å –∂–∞—É–∞–ø (JSON)
              </label>
              <textarea
                v-model="correctAnswerJson"
                rows="4"
                class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none font-mono text-sm"
                placeholder='–ê–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ –∫–æ–¥—Ç–∞–Ω –∞–Ω—ã“õ—Ç–∞–ª–∞–¥—ã'
              ></textarea>
              <p class="text-xs text-gray-500 mt-1">
                –ê–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ –∫–æ–¥—Ç–∞–Ω –∞–Ω—ã“õ—Ç–∞–ª–∞–¥—ã
              </p>
            </div>

            <!-- –¢“Ø—Å—ñ–Ω–¥—ñ—Ä–º–µ -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                –¢“Ø—Å—ñ–Ω–¥—ñ—Ä–º–µ
              </label>
              <textarea
                v-model="formData.explanation"
                rows="3"
                class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                placeholder="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –∫–æ–¥–∞"
              ></textarea>
            </div>

            <!-- –î–µ“£–≥–µ–π -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                –î–µ“£–≥–µ–π (1-5)
              </label>
              <input
                v-model.number="formData.level"
                type="number"
                min="1"
                max="5"
                class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none"
                placeholder="1"
              />
              <p class="text-xs text-gray-500 mt-1">1 = –µ“£ –æ“£–∞–π, 5 = –µ“£ “õ–∏—ã–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1)</p>
            </div>
          </div>

          <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
          <div class="text-center">
            <button
              type="button"
              @click="showAdvanced = !showAdvanced"
              class="text-sm text-blue-600 hover:text-blue-800 underline"
            >
              {{ showAdvanced ? '–°–∫—Ä—ã—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å' }} —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
          </div>

          <!-- –ö–Ω–æ–ø–∫–∏ -->
          <div class="flex gap-4 pt-4">
            <Button type="submit" variant="primary" :loading="submitting" class="px-8">
              ‚úÖ –°–∞“õ—Ç–∞—É
            </Button>
            <Button type="button" variant="outline" @click="resetForm">
              üîÑ –¢–∞–∑–∞–ª–∞—É
            </Button>
          </div>
        </form>
      </div>

      <!-- –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ -->
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">üìù –ú—ã—Å–∞–ª –∫–æ–¥—ã:</h3>
        <p class="text-sm text-gray-600 mb-3">
          –¢”©–º–µ–Ω–¥–µ –º—ã—Å–∞–ª –∫”©—Ä—Å–µ—Ç—ñ–ª–≥–µ–Ω. –û—Å—ã–Ω–¥–∞–π –∫–æ–¥—Ç—ã –∫”©—à—ñ—Ä—ñ–ø, –∂–æ“ì–∞—Ä—ã–¥–∞“ì—ã ”©—Ä—ñ—Å–∫–µ “õ–æ–π—ã“£—ã–∑:
        </p>
        <div class="bg-white p-4 rounded border border-gray-300 overflow-x-auto">
          <pre class="text-xs"><code>{{ exampleCode }}</code></pre>
        </div>
        <button
          @click="copyExampleCode"
          class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm"
        >
          üìã –ú—ã—Å–∞–ª –∫–æ–¥—Ç—ã –∫”©—à—ñ—Ä—É
        </button>
      </div>

      <!-- –£—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ -->
      <div v-if="successMessage" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
        ‚úÖ {{ successMessage }}
      </div>
    </main>
    <Footer />
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import { useAuthStore } from '@/stores/auth'
import { useCatalogStore } from '@/stores/catalog'
import { adminApi } from '@/api/admin'
import router from '@/router'
import Header from '@/components/layout/Header.vue'
import Footer from '@/components/layout/Footer.vue'
import Button from '@/components/ui/Button.vue'

const authStore = useAuthStore()
const loading = ref(false)
const submitting = ref(false)
const error = ref<string | null>(null)
const successMessage = ref<string | null>(null)
const correctAnswerJson = ref('{}')
const autoFilled = ref(false)
const autoFilledFields = ref<string[]>([])
const showAdvanced = ref(false)

const formData = ref({
  skill_id: 0,
  prompt: '',
  component_code: '',
  explanation: '',
  level: 1,
  metadata: {},
})

const exampleCode = ref(`import React, { useState, useEffect } from 'react';
import { RefreshCw, CheckCircle, XCircle, Brain, Award } from 'lucide-react';

const KazakhPlaceValueGenerator = () => {
  const [currentQuestion, setCurrentQuestion] = useState(null);
  const [selectedAnswer, setSelectedAnswer] = useState('');
  const [showResult, setShowResult] = useState(false);
  const [score, setScore] = useState({ correct: 0, total: 0 });
  
  const placeValues = {
    ones: { kz: "–±—ñ—Ä–ª—ñ–∫—Ç–µ—Ä –æ—Ä–Ω—ã", en: "ones place" },
    tens: { kz: "–æ–Ω–¥—ã“õ—Ç–∞—Ä –æ—Ä–Ω—ã", en: "tens place" },
    hundreds: { kz: "–∂“Ø–∑–¥—ñ–∫—Ç–µ—Ä –æ—Ä–Ω—ã", en: "hundreds place" },
  };

  const generateQuestion = () => {
    const number = Math.floor(Math.random() * 900) + 100;
    const place = 'ones';
    const correctAnswer = number % 10;
    
    setCurrentQuestion({
      number: number.toString(),
      place: place,
      question: \`\${number.toString()} —Å–∞–Ω—ã–Ω–¥–∞ \${placeValues[place].kz}–Ω–¥–∞ “õ–∞–Ω–¥–∞–π —Ü–∏—Ñ—Ä —Ç“±—Ä?\`,
      options: [correctAnswer, 1, 2, 3],
      correctAnswer: correctAnswer.toString(),
    });
  };

  const checkAnswer = () => {
    if (!currentQuestion) return;
    const isCorrect = selectedAnswer === currentQuestion.correctAnswer;
    setShowResult(true);
    setScore(prev => ({
      correct: prev.correct + (isCorrect ? 1 : 0),
      total: prev.total + 1
    }));
    if (isCorrect) {
      setTimeout(() => {
        generateQuestion();
      }, 1500);
    }
  };

  useEffect(() => {
    generateQuestion();
  }, []);

  return (
    <div className="max-w-4xl mx-auto p-6">
      <div className="bg-white rounded-xl shadow-lg p-8">
        <h1 className="text-3xl font-bold text-gray-800 mb-2">–†–∞–∑—Ä—è–¥—Ç–∞—Ä</h1>
        
        {currentQuestion && (
          <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-6 mb-6">
            <h2 className="text-xl font-semibold text-gray-800 mb-4 text-center">
              {currentQuestion.question}
            </h2>
            
            <div className="text-center mb-6">
              <div className="text-4xl font-bold text-blue-600 font-mono">
                {currentQuestion.number}
              </div>
            </div>

            <div className="grid grid-cols-2 gap-3 max-w-md mx-auto">
              {currentQuestion.options.map((option, index) => (
                <button
                  key={index}
                  onClick={() => setSelectedAnswer(option.toString())}
                  disabled={showResult}
                  className={\`p-3 rounded-lg border-2 transition-all \${
                    selectedAnswer === option.toString()
                      ? 'border-blue-500 bg-blue-50 text-blue-700'
                      : 'border-gray-300 hover:border-gray-400 bg-white'
                  }\`}
                >
                  {option}
                </button>
              ))}
            </div>

            {!showResult && selectedAnswer && (
              <div className="text-center mt-6">
                <button
                  onClick={checkAnswer}
                  className="px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700"
                >
                  –ñ–∞—É–∞–ø—Ç—ã —Ç–µ–∫—Å–µ—Ä—É
                </button>
              </div>
            )}

            {showResult && (
              <div className="mt-6 p-4 rounded-lg text-center">
                {selectedAnswer === currentQuestion.correctAnswer ? (
                  <div className="flex items-center justify-center gap-2 text-green-600">
                    <CheckCircle size={24} />
                    <span className="text-lg font-semibold">–î“±—Ä—ã—Å!</span>
                  </div>
                ) : (
                  <div className="text-red-600">
                    <div className="flex items-center justify-center gap-2 mb-2">
                      <XCircle size={24} />
                      <span className="text-lg font-semibold">“ö–∞—Ç–µ!</span>
                    </div>
                    <div className="text-sm">
                      –î“±—Ä—ã—Å –∂–∞—É–∞–ø: <span className="font-bold">{currentQuestion.correctAnswer}</span>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
};

export default KazakhPlaceValueGenerator;`)

const handleSubmit = async () => {
  submitting.value = true
  error.value = null
  successMessage.value = null

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
  if (!authStore.isAuthenticated) {
    error.value = '–ñ“Ø–π–µ–≥–µ –∫—ñ—Ä—É “õ–∞–∂–µ—Ç!'
    submitting.value = false
    return
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å
  if (authStore.user?.role !== 'ADMIN') {
    error.value = '–¢–µ–∫ ”ô–∫—ñ–º—à—ñ–ª–µ—Ä —Ç–∞–ø—Å—ã—Ä–º–∞ “õ–æ—Å–∞ –∞–ª–∞–¥—ã!'
    submitting.value = false
    return
  }

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–æ–ª—è –∏–∑ –∫–æ–¥–∞
  if (formData.value.component_code) {
    autoFillFromCode()
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
  if (!formData.value.component_code) {
    error.value = '–ö–æ–¥—Ç—ã –∫—ñ—Ä—ñ—Å—Ç—ñ—Ä—É –º—ñ–Ω–¥–µ—Ç—Ç—ñ!'
    submitting.value = false
    return
  }

  // –ï—Å–ª–∏ prompt –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω –∏–ª–∏ –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
  if (!formData.value.prompt || !formData.value.prompt.trim()) {
    const componentNameMatch = formData.value.component_code.match(/const\s+(\w+)\s*=|export\s+default\s+(\w+)|function\s+(\w+)/i)
    if (componentNameMatch) {
      const componentName = componentNameMatch[1] || componentNameMatch[2] || componentNameMatch[3]
      formData.value.prompt = componentName
        .replace(/([A-Z])/g, ' $1')
        .replace(/^./, str => str.toUpperCase())
        .trim() || '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—Ç—ñ —Ç–∞–ø—Å—ã—Ä–º–∞'
    } else {
      formData.value.prompt = '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—Ç—ñ —Ç–∞–ø—Å—ã—Ä–º–∞'
    }
  }
  
  // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ prompt –Ω–µ –ø—É—Å—Ç–æ–π (—É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã)
  formData.value.prompt = formData.value.prompt.trim() || '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—Ç—ñ —Ç–∞–ø—Å—ã—Ä–º–∞'

  try {
    let correctAnswer = {}
    if (correctAnswerJson.value.trim() && correctAnswerJson.value !== '{}') {
      try {
        correctAnswer = JSON.parse(correctAnswerJson.value)
      } catch (e) {
        // –ï—Å–ª–∏ JSON –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π, —Å–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç
        correctAnswer = { answer: correctAnswerJson.value }
      }
    } else {
      // –ï—Å–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–µ —É–∫–∞–∑–∞–Ω, —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç
      correctAnswer = {}
    }

    // –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –Ω–∞–≤—ã–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - –∞–¥–º–∏–Ω –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–¥
    // –≠—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å: –∞–¥–º–∏–Ω –Ω–µ –¥–æ–ª–∂–µ–Ω –¥—É–º–∞—Ç—å –æ skill_id
    let finalSkillId = 0
    // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ skill_id - –≤—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
    {
      try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è subjects –∏ grades
        const catalogStore = useCatalogStore()
        const subjects = await catalogStore.getSubjects()
        const grades = await catalogStore.getGrades()
        
        const firstSubject = subjects[0]
        const firstGrade = grades[0]
        
        if (firstSubject && firstGrade) {
          // –°–æ–∑–¥–∞–µ–º –Ω–∞–≤—ã–∫ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω API
          const skillCode = `INTERACTIVE_${Date.now()}`
          
          // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ prompt –Ω–µ –ø—É—Å—Ç–æ–π - –µ—Å–ª–∏ –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –∫–æ–¥–∞ –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ
          let skillTitle = (formData.value.prompt || '').trim()
          if (!skillTitle) {
            // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –∫–æ–¥–∞
            const componentNameMatch = formData.value.component_code.match(/const\s+(\w+)\s*=|export\s+default\s+(\w+)|function\s+(\w+)/i)
            if (componentNameMatch) {
              const componentName = componentNameMatch[1] || componentNameMatch[2] || componentNameMatch[3]
              skillTitle = componentName
                .replace(/([A-Z])/g, ' $1')
                .replace(/^./, str => str.toUpperCase())
                .trim()
            }
          }
          
          // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
          if (!skillTitle || skillTitle.length < 3) {
            skillTitle = '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—Ç—ñ —Ç–∞–ø—Å—ã—Ä–º–∞'
          }
          
          console.log('Creating skill:', { subject_id: firstSubject.id, grade_id: firstGrade.id, code: skillCode, title: skillTitle })
          
          const skillResponse = await adminApi.createSkill({
            subject_id: firstSubject.id,
            grade_id: firstGrade.id,
            code: skillCode,
            title: skillTitle,
            description: '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–π –Ω–∞–≤—ã–∫ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞',
            is_published: true
          })
          
          console.log('Skill created:', skillResponse)
          
          if (!skillResponse.data || !skillResponse.data.id) {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –Ω–∞–≤—ã–∫–∞')
          }
          
          finalSkillId = skillResponse.data.id
          console.log('Using skill_id:', finalSkillId)
          successMessage.value = `‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –Ω–∞–≤—ã–∫: ${skillTitle} (ID: ${finalSkillId})`
        } else {
          throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø—Ä–µ–¥–º–µ—Ç—ã –∏–ª–∏ –∫–ª–∞—Å—Å—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–≤—ã–∫–∞')
        }
      } catch (err: any) {
        console.error('Failed to create skill:', err)
        const errorMsg = err.response?.data?.error?.message || err.response?.data?.message || err.message
        error.value = `–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–∞–≤—ã–∫: ${errorMsg}. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É.`
        submitting.value = false
        return
      }
    }
    // –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –Ω–∞–≤—ã–∫ - –∞–¥–º–∏–Ω –Ω–µ –¥–æ–ª–∂–µ–Ω —É–∫–∞–∑—ã–≤–∞—Ç—å skill_id

    const requestData = {
      skill_id: finalSkillId,
      prompt: formData.value.prompt,
      component_code: formData.value.component_code,
      correct_answer: correctAnswer,
      explanation: formData.value.explanation || '',
      level: formData.value.level || 1,
      metadata: formData.value.metadata,
    }

    console.log('Sending request to create interactive question:', {
      url: '/admin/questions/interactive',
      data: { ...requestData, component_code: requestData.component_code.substring(0, 100) + '...' }
    })

    await adminApi.createInteractiveQuestion(requestData)

    // –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ
    successMessage.value = '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!'
    resetForm()
    setTimeout(() => {
      successMessage.value = null
    }, 5000)
  } catch (err: any) {
    console.error('Failed to create interactive question:', err)
    console.error('Error details:', {
      message: err.message,
      response: err.response?.data,
      status: err.response?.status,
      url: err.config?.url
    })
    
    if (err.code === 'ERR_NETWORK' || err.message?.includes('Network Error')) {
      error.value = '–ñ–µ–ª—ñ “õ–∞—Ç–µ—Å—ñ: –°–µ—Ä–≤–µ—Ä–≥–µ “õ–æ—Å—ã–ª—É –º“Ø–º–∫—ñ–Ω –µ–º–µ—Å. –°–µ—Ä–≤–µ—Ä –∂“±–º—ã—Å —ñ—Å—Ç–µ–ø —Ç“±—Ä“ì–∞–Ω—ã–Ω —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑ (http://localhost:8000).'
    } else if (err.response?.status === 401) {
      const errorDetail = err.response.data?.detail || err.response.data?.error
      if (errorDetail?.message) {
        error.value = `–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è “õ–∞—Ç–µ—Å—ñ: ${errorDetail.message}. –ñ“Ø–π–µ–≥–µ “õ–∞–π—Ç–∞ –∫—ñ—Ä—ñ“£—ñ–∑.`
      } else {
        error.value = '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è “õ–∞–∂–µ—Ç! –¢–æ–∫–µ–Ω –º–µ—Ä–∑—ñ–º—ñ –∞—è“õ—Ç–∞–ª“ì–∞–Ω –±–æ–ª—É—ã –º“Ø–º–∫—ñ–Ω. –ñ“Ø–π–µ–≥–µ “õ–∞–π—Ç–∞ –∫—ñ—Ä—ñ“£—ñ–∑.'
      }
      
      // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => {
        if (confirm('–¢–æ–∫–µ–Ω –º–µ—Ä–∑—ñ–º—ñ –∞—è“õ—Ç–∞–ª“ì–∞–Ω —Å–∏—è“õ—Ç—ã. –ñ“Ø–π–µ–≥–µ “õ–∞–π—Ç–∞ –∫—ñ—Ä—É –∫–µ—Ä–µ–∫ –ø–µ?')) {
          router.push({ name: 'login', query: { redirect: router.currentRoute.value.fullPath } })
        }
      }, 2000)
    } else if (err.response?.status === 403) {
      error.value = '–°—ñ–∑–¥–µ –±“±–ª ”ô—Ä–µ–∫–µ—Ç—Ç—ñ –æ—Ä—ã–Ω–¥–∞—É“ì–∞ —Ä“±“õ—Å–∞—Ç –∂–æ“õ. –¢–µ–∫ ”ô–∫—ñ–º—à—ñ–ª–µ—Ä —Ç–∞–ø—Å—ã—Ä–º–∞ “õ–æ—Å–∞ –∞–ª–∞–¥—ã. –†”©–ª—ñ“£—ñ–∑–¥—ñ —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑.'
    } else if (err.response?.status === 404) {
      error.value = 'Endpoint —Ç–∞–±—ã–ª–º–∞–¥—ã. –°–µ—Ä–≤–µ—Ä –∂–∞“£–∞—Ä—Ç—ã–ª“ì–∞–Ω—ã–Ω —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑.'
    } else {
      const errorMessage = err.response?.data?.message || err.response?.data?.detail?.message || err.message
      error.value = errorMessage || '–¢–∞–ø—Å—ã—Ä–º–∞ “õ–æ—Å—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ –ø–∞–π–¥–∞ –±–æ–ª–¥—ã.'
    }
  } finally {
    submitting.value = false
  }
}

const resetForm = () => {
  formData.value = {
    skill_id: 0,
    prompt: '',
    component_code: '',
    explanation: '',
    level: 1,
    metadata: {},
  }
  correctAnswerJson.value = '{}'
  error.value = null
  successMessage.value = null
}

const copyExampleCode = () => {
  navigator.clipboard.writeText(exampleCode.value)
  successMessage.value = '–ú—ã—Å–∞–ª –∫–æ–¥ –∫”©—à—ñ—Ä—ñ–ª–¥—ñ! –ï–Ω–¥—ñ –æ–Ω—ã –∂–æ“ì–∞—Ä—ã–¥–∞“ì—ã ”©—Ä—ñ—Å–∫–µ “õ–æ–π—ã“£—ã–∑.'
  setTimeout(() => {
    successMessage.value = null
  }, 3000)
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π –∏–∑ –∫–æ–¥–∞
const autoFillFromCode = () => {
  const code = formData.value.component_code
  if (!code || code.length < 50) {
    autoFilled.value = false
    autoFilledFields.value = []
    return
  }

  const filled: string[] = []

  // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –¥–ª—è prompt
  const componentNameMatch = code.match(/const\s+(\w+)\s*=|export\s+default\s+(\w+)|function\s+(\w+)/i)
  if (componentNameMatch) {
    const componentName = componentNameMatch[1] || componentNameMatch[2] || componentNameMatch[3]
    if (componentName && !formData.value.prompt) {
      // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∫–æ–¥–µ
      const titleMatch = code.match(/h1[^>]*>([^<]+)|title[^>]*>([^<]+)|['"]([^'"]+)[^>]*>.*–†–∞–∑—Ä—è–¥|–†–∞–∑—Ä—è–¥[^<]*/i)
      if (titleMatch) {
        formData.value.prompt = titleMatch[1] || titleMatch[2] || titleMatch[3] || componentName
        filled.push('–°“±—Ä–∞“õ –º”ô—Ç—ñ–Ω—ñ')
      } else {
        formData.value.prompt = componentName.replace(/([A-Z])/g, ' $1').trim()
        filled.push('–°“±—Ä–∞“õ –º”ô—Ç—ñ–Ω—ñ')
      }
    }
  }

  // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–∑ –ª–æ–≥–∏–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
  if (!correctAnswerJson.value || correctAnswerJson.value === '{}') {
    // –ò—â–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞
    const correctAnswerMatch = code.match(/correctAnswer[:\s=]+['"]([^'"]+)['"]|correctAnswer[:\s=]+(\d+)|isCorrect.*===.*['"]([^'"]+)['"]|isCorrect.*===.*(\d+)/i)
    if (correctAnswerMatch) {
      const answer = correctAnswerMatch[1] || correctAnswerMatch[2] || correctAnswerMatch[3] || correctAnswerMatch[4]
      if (answer) {
        correctAnswerJson.value = JSON.stringify({ answer: answer })
        filled.push('–î“±—Ä—ã—Å –∂–∞—É–∞–ø')
      }
    } else {
      // –ò—â–µ–º –≤ currentQuestion
      const questionMatch = code.match(/correctAnswer[:\s=]+['"]([^'"]+)['"]|correctAnswer[:\s=]+(\d+)/i)
      if (questionMatch) {
        const answer = questionMatch[1] || questionMatch[2]
        if (answer) {
          correctAnswerJson.value = JSON.stringify({ answer: answer })
          filled.push('–î“±—Ä—ã—Å –∂–∞—É–∞–ø')
        }
      }
    }
  }

  // –ò–∑–≤–ª–µ–∫–∞–µ–º explanation –µ—Å–ª–∏ –µ—Å—Ç—å
  if (!formData.value.explanation) {
    const explanationMatch = code.match(/explanation[:\s=]+['"]([^'"]+)['"]|–¢“Ø—Å—ñ–Ω–¥—ñ—Ä–º–µ[:\s=]+['"]([^'"]+)['"]/i)
    if (explanationMatch) {
      formData.value.explanation = explanationMatch[1] || explanationMatch[2]
      filled.push('–¢“Ø—Å—ñ–Ω–¥—ñ—Ä–º–µ')
    }
  }

  if (filled.length > 0) {
    autoFilled.value = true
    autoFilledFields.value = filled
  }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
if (!authStore.isAuthenticated || authStore.user?.role !== 'ADMIN') {
  error.value = '–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è'
}
</script>
